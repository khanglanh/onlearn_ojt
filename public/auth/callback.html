<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cognito Callback</title>
  </head>
  <body>
    <script>
      (function() {
        function parseQuery(qs) {
          const params = {};
          const parts = qs.replace(/^\?/, '').split('&').filter(Boolean);
          for (const part of parts) {
            const [k,v] = part.split('=');
            params[decodeURIComponent(k)] = decodeURIComponent(v || '');
          }
          return params;
        }

        const params = parseQuery(window.location.search || '');
        const payload = {
          type: 'cognito_callback',
          code: params.code || null,
          state: params.state || null,
          error: params.error || null,
          error_description: params.error_description || null,
          raw: params
        };
        try {
          if (window.opener && !window.opener.closed) {
              // post back to the opener; specify origin if your opener is same-origin
              // NOTE: opener and callback should be same origin for easier validation
              window.opener.postMessage(payload, window.location.origin);
          } else {
            // fallback: store in localStorage for the main window to pick up
            try { localStorage.setItem('cognito_callback', JSON.stringify(payload)); } catch(e){}
          }
        } catch (e) {
          console.error('cognito callback postMessage failed', e);
        }

        // close popup after short delay
        setTimeout(() => {
          try { window.close(); } catch(e) {}
        }, 500);
      })();
    </script>
    <p>Signing in... you can close this window.</p>
  </body>
  </html>
